<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Buzz ‚Äî Emotion & Sentiment</title>
    <link rel="icon" type="image/png" href="/buzz-icon.png" />
    <style>
      *, *::before, *::after { box-sizing: border-box; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
      .card { max-width: 800px; margin: 0 auto; border: 1px solid #ddd; border-radius: 9px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,.06); background-color: snow; }
      h1 { font-size: 20px; margin: 0 0 16px; }
      label { font-weight: 600; display: block; margin: 12px 0 6px; }
      textarea { width: 100%; min-height: 120px; padding: 10px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
      select, button, input[type=text] { padding: 8px 10px; font-size: 14px; }
      .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
      .row > * { margin: 6px 0; }
      .out { background: #0b1020; color: #c9e2ff; white-space: pre-wrap; padding: 12px; border-radius: 6px; min-height: 80px; overflow:auto; font-family: monaco, SFMono-Regular, Menlo, Consolas, monospace; font-size: 8pt; line-height: 1.5; }
      .muted { color: #666; font-size: 12px; display: none }
      .tag { display:inline-block; color:#334; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:8px; font-weight: 160; float: right; }
      /* --- Visualization of parsed JSON scores --- */
      .viz { margin-top: 0; }
      .tiles { display: flex; gap: 14px; align-items: stretch; flex-wrap: wrap; margin: 12px 0 4px; }
      .tile { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80px; min-width: 80px; padding: 8px 10px; border: 1px solid #e5e7eb; border-radius: 6px; background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,.03); }
      .tiles.emotions .tile { background: #f6f9ff; }
      .tiles.sentiment .tile { background: #f9fff6; }
      .tile .emoji { font-size: 28px; line-height: 1; }
      .tile .score { font-size: 12px; color: #334; margin-top: 4px; }
      .tile .label { font-size: 11px; color: #666; text-transform: capitalize; margin-top: 2px; }
      .results { display: flex; gap: 12px; align-items: stretch; flex-wrap: wrap; }
      .results .viz { flex: 1 1 280px; }
      .results .full-score { flex: 2 1 460px; min-width: 320px; }
      .full-score .out { width: 100%; }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Buzz Classifier ‚Äî Emotion & Sentiment <span class="tag">sveselev-moonshine 2025</span></h1>
      <div id="app"></div>
      <p class="muted">Tip: this page calls the same-origin API. Deploying elsewhere may require CORS.</p>
      <p style="text-align:left; margin-top:16px;">
        <a href="/api-docs" target="_blank" style="text-decoration:none; color:#0077cc; font-weight:500; ">
          ‚Üí View full API documentation
        </a>
      </p>
    </div>

    <!-- React via CDN (UMD) + Babel Standalone for in‚Äëbrowser JSX -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    <script type="text/babel" data-presets="react">
        /* global React, ReactDOM */
        // ---- Sanity check: ensure React & ReactDOM are present and can mount ----
        console.log('React:', (window.React && React.version) || 'n/a', 'ReactDOM:', (window.ReactDOM && ReactDOM.version) || 'n/a', 'Babel:', !!window.Babel);

        const { useState } = React;

        const LANGS = [
            { code: 'en', name: 'English' },
            { code: 'es', name: 'Spanish' },
            { code: 'fr', name: 'French' },
            { code: 'de', name: 'German' },
            { code: 'it', name: 'Italian' },
            { code: 'nl', name: 'Dutch' },
            { code: 'pt', name: 'Portuguese' },
            { code: 'ru', name: 'Russian' },
            { code: 'sv', name: 'Sweden' },
            { code: 'tr', name: 'Turkish' },
            { code: 'zh', name: 'Chinese' },
            { code: 'ja', name: 'Japanese' },
            { code: 'ko', name: 'Korean' },
            { code: 'ar', name: 'Arabic' },
            { code: 'id', name: 'Indonesian' },
            { code: 'ms', name: 'Malaysian' },
        ];

        function App() {
            const [text, setText] = useState('Wish you were here');
            const [lang, setLang] = useState('en');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [result, setResult] = useState('');

            const THRESH = 0.10; // hide scores below 0.10
            const toPct = v => (v * 100).toFixed(1) + '%';
            const safeParse = (s) => { try { return JSON.parse(s); } catch (e) { return null; } };
            const EMOJI = { JOY:'üòä', SADNESS:'üò¢', ANGER:'üò†', FEAR:'üò®', DISGUST:'ü§¢', SURPRISE:'üòÆ', NEUTRAL:'üòê' };
            const SENT_EMOJI = { POSITIVE:'üôÇ', NEGATIVE:'üôÅ', NEUTRAL:'üòê' };

        async function run() {
            setLoading(true); setError(''); setResult('');
            try {
                const url = `/api/buzz/score?text=${encodeURIComponent(text)}&lang=${encodeURIComponent(lang)}`;
                const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const json = await res.json();
                setResult(JSON.stringify(json, null, 2));
            } catch (e) {
                setError(String(e));
            } finally {
                setLoading(false);
            }
        }

        return (
          <div>
            <label htmlFor="txt">Text</label>
            <textarea id="txt" value={text} onChange={e => setText(e.target.value)} placeholder="Enter text to analyze..." />

            <div className="row">
              <div>
                <label htmlFor="lang">Language</label>
                <select id="lang" value={lang} onChange={e => setLang(e.target.value)}>
                  {LANGS.map(l => <option key={l.code} value={l.code}>{l.name} ({l.code})</option>)}
                </select>
              </div>
              <div>
                <label style={{visibility:'hidden'}}>run</label>
                <button onClick={run} disabled={loading}>{loading ? 'Running‚Ä¶' : 'Analyze'}</button>
              </div>
            </div>

            {error && <p style={{color:'#b00020'}}>Error: {error}</p>}
            <label>Result</label>
            <div className="results">
              {(() => {
                const data = safeParse(result);
                const emotions = data && (data.Emotion || data.emotion);
                const sentiment = data && (data.Sentiment || data.sentiment);

                const emoTiles = emotions ? Object.entries(emotions)
                  .filter(([k,v]) => typeof v === 'number')
                  .sort((a,b) => b[1] - a[1])
                  .slice(0, 3) : [];

                const sentTiles = sentiment ? Object.entries(sentiment)
                  .filter(([k,v]) => typeof v === 'number')
                  .sort((a,b) => b[1] - a[1])
                  .slice(0, 3) : [];

                return (
                  <div className="viz">
                    <div className="tiles emotions">
                      {emoTiles.length > 0 ? (
                        emoTiles.map(([k,v]) => (
                          <div key={'e'+k} className="tile">
                            <div className="emoji">{EMOJI[k] || 'üôÇ'}</div>
                            <div className="score">{toPct(v)}</div>
                            <div className="label">{k.toLowerCase()}</div>
                          </div>
                        ))
                      ) : (
                        <React.Fragment>
                          <div className="tile" style={{opacity:.6}}>
                            <div className="emoji">üôÇ</div>
                            <div className="label">No data yet</div>
                          </div>
                          <div className="tile" style={{opacity:.6}}></div>
                          <div className="tile" style={{opacity:.6}}></div>
                        </React.Fragment>
                      )}
                    </div>

                    <div className="tiles sentiment">
                      {sentTiles.length > 0 ? (
                        sentTiles.map(([k,v]) => (
                          <div key={'s'+k} className="tile">
                            <div className="emoji">{SENT_EMOJI[k] || 'üòê'}</div>
                            <div className="score">{toPct(v)}</div>
                            <div className="label">{k.toLowerCase()}</div>
                          </div>
                        ))
                      ) : (
                        <React.Fragment>
                          <div className="tile" style={{opacity:.6}}>
                            <div className="emoji">üôÇ</div>
                            <div className="label">No data yet</div>
                          </div>
                          <div className="tile" style={{opacity:.6}}></div>
                          <div className="tile" style={{opacity:.6}}></div>
                        </React.Fragment>
                      )}
                    </div>
                  </div>
                );
              })()}

              <div className="full-score">
                <pre className="out">{result || '‚Äî'}</pre>
              </div>
            </div>
          </div>
        );
      }

        const root = ReactDOM.createRoot(document.getElementById('app'));
        root.render(<App/>);
    </script>
  </body>
</html>